<html>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="res/cell.js"></script>
  <link href="res/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="res/index.css">
  <script>

var getTableRow = function(item){
  return {
	$type: "div",
	class: "view",
	$components: [
	  { $type: "input",
		autocomplete: "off",
		class: "toggle",
		id: item.name,
		type: "checkbox",
		onclick: function(e) {
		  if(item.done){
			item.done = false;
			item.comp.$components[1] = { $type: "label", $text: item.name };
			item.comp.$components[0].checked = null
		  }
		  else {
			item.done = true
			item.comp.$components[1] =  { $type: "label", $text: item.name, style: "text-decoration: line-through; color: #d9d9d9;" };
			item.comp.$components[0].checked = true;
		  }
		  this._updateTableRows()
		}
	  },
	{ $type: "label", $text: item.name },
	{ $type: "button",
	  class: "btn btn-warning destroy ",
	  onclick: function(e){
		this._remove(item)
	  }
	}]
  }
}

function Todo(name, done){
  this.name = name;
  this.done = done;
  this.comp = Object.create(getTableRow(this))
}

var Inp = {
  $type: "div",
  _add: function() {
	var newTodo = new Todo(document.querySelector('#inp').value, false);
	this._todos.push(newTodo)
	document.querySelector('#inp').value = "";
  },
  $components: [{
	$type: "input",
	id: "inp",
	class: "new-todo",
	placeholder: "What needs to be done",
	onkeyup: function(e){
	  if(e.keyCode == 13){
		this._add()
	  }
	}
  }]
}

var TodosTable = { 
  $type: "ul",
  class: "todo-list",
  $components: [
	{ $type: "li",
	  class: "todo",
	  $components: [],
	  _updateTableRows: function(){
		this.$components = this._display.map(item => item.comp)
	  }
	} ],
  _update: function(list){
	this.$components[0]._updateTableRows()
  }
}

var Footer = {
  $type: "footer",
  class: "hidden",
  $components: [
	{ $type: "span",
	  class: "todo-count",
	  $text: 0,
	  _updateCount: function(){
		this.$text = this._todos.length + " items left"
	  }
	},
	{ $type: "ul",
	  class: "filters",
	  $components: [
		{ $type: "li",
		  $components: [
			{ $type: "a",
			  href: "#/all",
			  $text: "All",
			  onclick: function() { this._updateFilter(function(x) {return true}) } 
			},
			{ $type: "a",
			  href: "#/active",
			  $text: "Active",
			  onclick: function() { this._updateFilter(function(x) {return !x.done})} 
			},
			{ $type: "a",
			  href: "#/completed",
			  $text: "Completed",
			  onclick: function() { this._updateFilter(function(x) {return x.done})} 
			}
		  ]
		}]
	}],
  _update: function(){
	this.class = "footer"
	this.$components[0]._updateCount()
  }
}

var App = {
  $cell: true,
  $type: "div",
  style: "border: 5px",
  id: "main",
  _todos: [],
  _display: [],
  $components: [Inp, TodosTable, Footer],
  $update: function() {
	this._updateDisplay()
	this.$components[1]._update(this._todos);  
	this.$components[2]._update()
  },
  _remove: function(todo){
	var index = this._todos.indexOf(todo);
	this._todos.splice(index, 1)
	this.$update()
  },
  _filter: function(x) { return true },
  _updateFilter: function(fn) { 
	this._filter = fn 
	this.$update()
  },
  _updateDisplay: function(){
	this._display = this._todos.filter(this._filter)
  }
}

  </script>
  <body>
	<section class="todoapp">
	  <h1> todos </h1>
	  <div id="main"> </div>
	</section>
  </body>
</html>
